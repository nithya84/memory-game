service: memory-game-admin

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'local'}
  environment:
    NODE_ENV: ${self:provider.stage}
    USE_MOCK_AI: ${env:USE_MOCK_AI, 'true'}
    REGION: ${self:provider.region}
    S3_BUCKET: ${env:S3_BUCKET_NAME, 'memory-game-images-dev'}
    CLOUDFRONT_DOMAIN: ${env:CLOUDFRONT_DOMAIN, ''}
    THEMES_TABLE: ${env:THEMES_TABLE, 'memory-game-api-themes-dev'}
    IMAGE_GENERATION_COUNT: 35
    ADMIN_TOKEN: ${env:ADMIN_TOKEN}

  iam:
    role:
      statements:
        # DynamoDB access
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/memory-game-*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/memory-game-*/index/*"

        # S3 access
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource:
            - "arn:aws:s3:::${env:S3_BUCKET_NAME, 'memory-game-images-dev'}/*"

        # Bedrock access for AI generation
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource:
            - "arn:aws:bedrock:${self:provider.region}::foundation-model/amazon.titan-image-generator-v2:0"
            - "arn:aws:bedrock:${self:provider.region}::foundation-model/anthropic.claude-3-haiku-20240307-v1:0"

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3002
    host: 0.0.0.0

functions:
  # Theme Generation (expensive - calls Bedrock 35+ times)
  generateTheme:
    handler: dist/src/handlers/admin.generateThemeForCuration
    timeout: 300  # 5 minutes for AI generation
    events:
      - http:
          path: /admin/themes/generate
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization

  # Theme Curation (moderate cost - deletes rejected images)
  curateTheme:
    handler: dist/src/handlers/admin.curateTheme
    events:
      - http:
          path: /admin/themes/{themeId}/curate
          method: put
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization

  # Get Single Theme by ID (includes images for curation)
  getThemeById:
    handler: dist/src/handlers/admin.getThemeById
    events:
      - http:
          path: /admin/themes/{themeId}
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization

  # Consolidate multiple themes into one
  consolidateThemes:
    handler: dist/src/handlers/admin.consolidateThemes
    events:
      - http:
          path: /admin/themes/consolidate
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization

  # Update preview image for a theme
  updateThemePreview:
    handler: dist/src/handlers/admin.updateThemePreview
    events:
      - http:
          path: /admin/themes/{themeId}/preview
          method: put
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization

  # Delete a theme
  deleteTheme:
    handler: dist/src/handlers/admin.deleteTheme
    events:
      - http:
          path: /admin/themes/{themeId}
          method: delete
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization

  # List All Themes (cheap - just DynamoDB scan)
  listThemes:
    handler: dist/src/handlers/admin.listThemes
    events:
      - http:
          path: /admin/themes
          method: get
          cors:
            origin: '*'
            headers:
              - Content-Type
              - Authorization

package:
  patterns:
    - '../node_modules/**'
    - 'dist/**'
    - '!../node_modules/aws-sdk/**'
    - '!../node_modules/@types/**'
    - '!../node_modules/**/*.d.ts'
    - '!../node_modules/**/test/**'
    - '!../node_modules/**/tests/**'
    - '!../node_modules/**/*.md'
    - '!../node_modules/**/README*'
    - '!../node_modules/**/docs/**'
    - '!../node_modules/**/*.map'

# NOTE: This service does NOT create any infrastructure resources.
# It references DynamoDB tables and S3 buckets created by the main service (serverless.yml).
# Deploy the main service first, then deploy this admin service.
